<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الجلسة النشطة - مراقب البيانات</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Animation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    
    <!-- Custom Styles -->
    <style>
        :root {
            --primary-dark: #1a237e;
            --primary-light: #3f51b5;
            --accent: #00bcd4;
            --text-dark: #212121;
            --text-light: #757575;
            --background: #ffffff;
            --surface: #f5f5f5;
        }
        
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-light) 100%);
            min-height: 100vh;
        }
        
        .arabic-text {
            font-family: 'Tajawal', sans-serif;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .session-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .timer-display {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(45deg, var(--accent), var(--primary-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            margin: 20px 0;
        }
        
        .data-display {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-dark);
            text-align: center;
            margin: 16px 0;
        }
        
        .progress-circle {
            width: 200px;
            height: 200px;
            margin: 0 auto;
            position: relative;
        }
        
        .progress-circle svg {
            transform: rotate(-90deg);
        }
        
        .progress-circle .bg-circle {
            fill: none;
            stroke: #e0e0e0;
            stroke-width: 12;
        }
        
        .progress-circle .progress-circle-fill {
            fill: none;
            stroke: var(--accent);
            stroke-width: 12;
            stroke-linecap: round;
            stroke-dasharray: 565.48;
            stroke-dashoffset: 565.48;
            transition: stroke-dashoffset 1s ease;
        }
        
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-dark);
        }
        
        .control-button {
            border: none;
            border-radius: 50px;
            padding: 16px 32px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 140px;
        }
        
        .end-button {
            background: linear-gradient(45deg, #f44336, #e91e63);
            color: white;
            box-shadow: 0 8px 25px rgba(244, 67, 54, 0.3);
        }
        
        .end-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(244, 67, 54, 0.4);
        }
        
        .pause-button {
            background: linear-gradient(45deg, #ff9800, #ffc107);
            color: white;
            box-shadow: 0 8px 25px rgba(255, 152, 0, 0.3);
        }
        
        .pause-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(255, 152, 0, 0.4);
        }
        
        .user-info-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .chart-container {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border-right: 4px solid var(--accent);
            z-index: 1000;
            transform: translateX(400px);
            opacity: 0;
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            padding: 12px 0;
            z-index: 1000;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            color: var(--text-light);
            text-decoration: none;
            transition: all 0.3s ease;
            border-radius: 12px;
            margin: 0 4px;
        }
        
        .nav-item.active {
            color: var(--primary-light);
            background: rgba(63, 81, 181, 0.1);
        }
        
        .nav-item:hover {
            color: var(--primary-light);
            background: rgba(63, 81, 181, 0.05);
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .floating {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        /* Android-specific styles */
        .android-device {
            --status-bar-height: 0px;
        }
        
        .android-device .pt-8 {
            padding-top: calc(2rem + var(--status-bar-height, 0px));
        }
        
        .android-device .session-card {
            margin-bottom: 16px;
        }
        
        .android-device .bottom-nav {
            height: 70px;
            padding-bottom: 8px;
        }
        
        .android-device .pb-20 {
            padding-bottom: 90px;
        }
        
        /* Android immersive mode support */
        .android-device .min-h-screen {
            min-height: 100vh;
            min-height: -webkit-fill-available;
        }
        
        /* Enhanced button feedback for Android */
        .android-device .control-button {
            position: relative;
            overflow: hidden;
        }
        
        .android-device .control-button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .android-device .control-button:active::after {
            width: 300px;
            height: 300px;
        }
        
        /* Android notification styles */
        .android-device .notification {
            top: calc(20px + var(--status-bar-height, 0px));
        }
        
        /* Android progress circle enhancement */
        .android-device .progress-circle {
            filter: drop-shadow(0 4px 8px rgba(0, 188, 212, 0.3));
        }
    </style>
</head>
<body>
    <!-- Main Content -->
    <div class="min-h-screen pb-20">
        <!-- Header -->
        <div class="pt-8 px-6 mb-6">
            <div class="user-info-card">
                <div class="flex items-center gap-4">
                    <img id="session-user-avatar" src="" alt="" class="w-16 h-16 rounded-full object-cover border-3 border-blue-500">
                    <div>
                        <h2 id="session-user-name" class="text-xl font-bold text-gray-800"></h2>
                        <p class="text-gray-600">جلسة نشطة</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Session Controls -->
        <div class="px-6 mb-6">
            <div class="session-card">
                <!-- Timer Display -->
                <div class="text-center mb-8">
                    <div class="text-sm text-gray-600 mb-2">الوقت المنقضي</div>
                    <div id="session-timer" class="timer-display arabic-text">00:00:00</div>
                </div>
                
                <!-- Data Usage Display -->
                <div class="text-center mb-8">
                    <div class="text-sm text-gray-600 mb-2">استهلاك البيانات</div>
                    <div id="session-data" class="data-display arabic-text">0.000</div>
                    <div class="text-sm text-gray-600">GB</div>
                </div>
                
                <!-- Progress Circle -->
                <div class="progress-circle mb-8">
                    <svg width="200" height="200">
                        <circle class="bg-circle" cx="100" cy="100" r="90"></circle>
                        <circle id="progress-circle-fill" class="progress-circle-fill" cx="100" cy="100" r="90"></circle>
                    </svg>
                    <div class="progress-text">
                        <span id="progress-percentage">0%</span>
                    </div>
                </div>
                
                <!-- Control Buttons -->
                <div class="flex gap-4 justify-center">
                    <button id="pause-session-btn" class="control-button pause-button">
                        إيقاف مؤقت
                    </button>
                    <button id="end-session-btn" class="control-button end-button">
                        إنهاء الجلسة
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Real-time Chart -->
        <div class="px-6 mb-6">
            <div class="chart-container">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">استهلاك البيانات اللحظي</h3>
                <div id="session-chart" style="height: 300px;"></div>
            </div>
        </div>
        
        <!-- Session Stats -->
        <div class="px-6 mb-6">
            <div class="grid grid-cols-2 gap-4">
                <div class="session-card text-center">
                    <div class="text-sm text-gray-600 mb-2">متوسط الاستهلاك</div>
                    <div id="avg-usage" class="text-2xl font-bold text-blue-600">0.00</div>
                    <div class="text-xs text-gray-500">MB/دقيقة</div>
                </div>
                <div class="session-card text-center">
                    <div class="text-sm text-gray-600 mb-2">السرعة الحالية</div>
                    <div id="current-speed" class="text-2xl font-bold text-green-600">0.00</div>
                    <div class="text-xs text-gray-500">MB/ثانية</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <div class="flex justify-around items-center max-w-md mx-auto">
            <a href="index.html" class="nav-item">
                <svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                </svg>
                <span class="text-xs">الرئيسية</span>
            </a>
            <a href="session.html" class="nav-item active">
                <svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12,6 12,12 16,14"/>
                </svg>
                <span class="text-xs">الجلسة</span>
            </a>
            <a href="analytics.html" class="nav-item">
                <svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M3 3v18h18v-2H5V3H3zm4 14h2V9H7v8zm4 0h2V7h-2v10zm4 0h2v-4h-2v4z"/>
                </svg>
                <span class="text-xs">التحليلات</span>
            </a>
            <a href="users.html" class="nav-item">
                <svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A1.5 1.5 0 0 0 18.54 8H17c-.8 0-1.54.37-2.01.99L12 13l-2.99-4.01A2.5 2.5 0 0 0 7 8H5.46c-.8 0-1.49.59-1.42 1.37L6.5 16H9v6h2v-6h2v6h2z"/>
                </svg>
                <span class="text-xs">المستخدمين</span>
            </a>
        </div>
    </nav>
    
    <script src="main.js"></script>
    <script>
        // Session page specific functionality
        class SessionPage {
            constructor() {
                this.chart = null;
                this.chartData = [];
                this.maxDataPoints = 60; // Keep last 60 seconds of data
                
                this.init();
            }
            
            init() {
                this.loadUserInfo();
                this.initChart();
                this.startRealTimeUpdates();
                this.setupControlButtons();
            }
            
            loadUserInfo() {
                const savedUser = localStorage.getItem('dataMonitor_currentUser');
                if (savedUser) {
                    const user = JSON.parse(savedUser);
                    
                    const avatarEl = document.getElementById('session-user-avatar');
                    const nameEl = document.getElementById('session-user-name');
                    
                    if (avatarEl) avatarEl.src = user.avatar;
                    if (nameEl) nameEl.textContent = user.name;
                }
            }
            
            initChart() {
                const chartContainer = document.getElementById('session-chart');
                if (!chartContainer) return;
                
                this.chart = echarts.init(chartContainer);
                
                const option = {
                    title: {
                        show: false
                    },
                    tooltip: {
                        trigger: 'axis',
                        formatter: function(params) {
                            return `الوقت: ${params[0].axisValue}<br/>البيانات: ${params[0].value} MB`;
                        }
                    },
                    xAxis: {
                        type: 'category',
                        data: [],
                        axisLabel: {
                            formatter: function(value) {
                                return value + 's';
                            }
                        }
                    },
                    yAxis: {
                        type: 'value',
                        name: 'MB',
                        axisLabel: {
                            formatter: '{value} MB'
                        }
                    },
                    series: [{
                        name: 'استهلاك البيانات',
                        type: 'line',
                        data: [],
                        smooth: true,
                        lineStyle: {
                            color: '#00bcd4',
                            width: 3
                        },
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0,
                                y: 0,
                                x2: 0,
                                y2: 1,
                                colorStops: [{
                                    offset: 0, color: 'rgba(0, 188, 212, 0.3)'
                                }, {
                                    offset: 1, color: 'rgba(0, 188, 212, 0.05)'
                                }]
                            }
                        },
                        symbol: 'circle',
                        symbolSize: 6,
                        itemStyle: {
                            color: '#00bcd4'
                        }
                    }],
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    }
                };
                
                this.chart.setOption(option);
                
                // Handle window resize
                window.addEventListener('resize', () => {
                    this.chart.resize();
                });
            }
            
            startRealTimeUpdates() {
                let seconds = 0;
                let totalData = 0;
                
                this.updateInterval = setInterval(() => {
                    seconds++;
                    
                    // Simulate data usage (in real app, this would come from system APIs)
                    const newData = Math.random() * 10 + 2; // 2-12 MB per second
                    totalData += newData;
                    
                    // Update timer
                    const hours = Math.floor(seconds / 3600);
                    const minutes = Math.floor((seconds % 3600) / 60);
                    const secs = seconds % 60;
                    
                    const timerEl = document.getElementById('session-timer');
                    if (timerEl) {
                        timerEl.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                    }
                    
                    // Update data display
                    const dataEl = document.getElementById('session-data');
                    if (dataEl) {
                        dataEl.textContent = (totalData / 1024).toFixed(3);
                    }
                    
                    // Update progress circle
                    const progress = Math.min((totalData / 1024) * 100, 100); // Assuming 1GB limit
                    this.updateProgressCircle(progress);
                    
                    // Update chart
                    this.updateChart(seconds, newData);
                    
                    // Update stats
                    this.updateStats(seconds, totalData);
                    
                    // Check for alerts
                    this.checkAlerts(totalData);
                    
                }, 1000);
            }
            
            updateProgressCircle(progress) {
                const circle = document.getElementById('progress-circle-fill');
                const percentage = document.getElementById('progress-percentage');
                
                if (circle) {
                    const circumference = 2 * Math.PI * 90; // radius = 90
                    const offset = circumference - (progress / 100) * circumference;
                    circle.style.strokeDashoffset = offset;
                    
                    // Change color based on progress
                    if (progress > 80) {
                        circle.style.stroke = '#f44336'; // Red
                    } else if (progress > 60) {
                        circle.style.stroke = '#ff9800'; // Orange
                    } else {
                        circle.style.stroke = '#00bcd4'; // Blue
                    }
                }
                
                if (percentage) {
                    percentage.textContent = Math.round(progress) + '%';
                }
            }
            
            updateChart(time, data) {
                if (!this.chart) return;
                
                // Add new data point
                this.chartData.push({
                    time: time,
                    value: data.toFixed(2)
                });
                
                // Keep only last N data points
                if (this.chartData.length > this.maxDataPoints) {
                    this.chartData.shift();
                }
                
                // Update chart
                const times = this.chartData.map(d => d.time);
                const values = this.chartData.map(d => d.value);
                
                this.chart.setOption({
                    xAxis: {
                        data: times
                    },
                    series: [{
                        data: values
                    }]
                });
            }
            
            updateStats(seconds, totalData) {
                // Calculate average usage
                const avgUsage = totalData / (seconds || 1);
                const avgUsageEl = document.getElementById('avg-usage');
                if (avgUsageEl) {
                    avgUsageEl.textContent = avgUsage.toFixed(2);
                }
                
                // Calculate current speed (last 5 seconds average)
                const recentData = this.chartData.slice(-5);
                const currentSpeed = recentData.length > 0 ? 
                    recentData.reduce((sum, d) => sum + parseFloat(d.value), 0) / recentData.length : 0;
                
                const speedEl = document.getElementById('current-speed');
                if (speedEl) {
                    speedEl.textContent = currentSpeed.toFixed(2);
                }
            }
            
            checkAlerts(totalData) {
                // Alert at 500MB, 750MB, and 900MB
                const thresholds = [500, 750, 900];
                const mbUsed = totalData;
                
                thresholds.forEach(threshold => {
                    if (mbUsed >= threshold && mbUsed < threshold + 10) {
                        this.showAlert(`تنبيه: لقد استهلكت ${threshold}MB من البيانات`);
                    }
                });
            }
            
            showAlert(message) {
                // Create alert notification
                const alert = document.createElement('div');
                alert.className = 'notification';
                alert.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center">
                            <svg class="w-4 h-4 text-yellow-600" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
                            </svg>
                        </div>
                        <div>
                            <div class="font-medium text-gray-800">تنبيه</div>
                            <div class="text-sm text-gray-600">${message}</div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(alert);
                
                // Animate in
                anime({
                    targets: alert,
                    translateX: [400, 0],
                    opacity: [0, 1],
                    duration: 500,
                    easing: 'easeOutElastic(1, .8)'
                });
                
                // Remove after 5 seconds
                setTimeout(() => {
                    anime({
                        targets: alert,
                        translateX: [0, 400],
                        opacity: [1, 0],
                        duration: 300,
                        easing: 'easeInQuad',
                        complete: () => {
                            document.body.removeChild(alert);
                        }
                    });
                }, 5000);
            }
            
            setupControlButtons() {
                const pauseBtn = document.getElementById('pause-session-btn');
                const endBtn = document.getElementById('end-session-btn');
                
                if (pauseBtn) {
                    pauseBtn.addEventListener('click', () => {
                        this.togglePause();
                    });
                }
                
                if (endBtn) {
                    endBtn.addEventListener('click', () => {
                        this.endSession();
                    });
                }
            }
            
            togglePause() {
                const pauseBtn = document.getElementById('pause-session-btn');
                
                if (this.updateInterval) {
                    // Pause
                    clearInterval(this.updateInterval);
                    this.updateInterval = null;
                    pauseBtn.textContent = 'استئناف';
                    pauseBtn.classList.remove('pause-button');
                    pauseBtn.classList.add('resume-button');
                } else {
                    // Resume
                    this.startRealTimeUpdates();
                    pauseBtn.textContent = 'إيقاف مؤقت';
                    pauseBtn.classList.remove('resume-button');
                    pauseBtn.classList.add('pause-button');
                }
            }
            
            endSession() {
                // Clear interval
                if (this.updateInterval) {
                    clearInterval(this.updateInterval);
                }
                
                // Show completion message
                this.showSessionComplete();
                
                // Redirect after delay
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 3000);
            }
            
            showSessionComplete() {
                const overlay = document.createElement('div');
                overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                overlay.innerHTML = `
                    <div class="bg-white rounded-2xl p-8 max-w-sm mx-4 text-center">
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-green-600" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">اكتملت الجلسة</h3>
                        <p class="text-gray-600 mb-4">تم حفظ بيانات الجلسة بنجاح</p>
                        <div class="text-sm text-gray-500">جاري العودة إلى الصفحة الرئيسية...</div>
                    </div>
                `;
                
                document.body.appendChild(overlay);
                
                // Animate completion
                anime({
                    targets: overlay.querySelector('div'),
                    scale: [0.8, 1],
                    opacity: [0, 1],
                    duration: 500,
                    easing: 'easeOutElastic(1, .8)'
                });
            }
        }
        
        // Initialize session page when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new SessionPage();
        });
    </script>
</body>
</html>